<!doctype html>
<html class="light" lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>MyFuel - Buscador Inteligente</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1e3a8a",
              "background-light": "#ffffff",
              "surface-light": "#f9fafb",
              "accent-red": "#f87171",
              "border-light": "#e5e7eb",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      .map-bg {
        background-color: #f3f4f6;
        background-image:
          radial-gradient(#e5e7eb 1px, transparent 1px),
          linear-gradient(to right, #e5e7eb 1px, transparent 1px);
        background-size:
          40px 40px,
          80px 80px;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      @keyframes loading {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
      }
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body
    class="bg-background-light font-display text-slate-800 h-screen w-screen overflow-hidden flex flex-col antialiased"
  >
    <!-- Map Section -->
    <div class="relative h-[45%] w-full map-bg overflow-hidden shadow-inner">
      <div
        id="status-overlay"
        class="absolute top-4 left-4 right-4 z-50 bg-white/90 backdrop-blur px-4 py-2 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between"
      >
        <span
          id="status-text"
          class="text-xs font-semibold text-primary uppercase tracking-wider"
          >Localizando...</span
        >
        <div
          id="loader"
          class="h-1.5 w-12 bg-slate-100 rounded-full overflow-hidden"
        >
          <div class="h-full bg-primary animate-[loading_1s_infinite]"></div>
        </div>
      </div>

      <!-- Placeholder for Interactive Map or static bg -->
      <img
        alt="Map"
        class="absolute inset-0 w-full h-full object-cover opacity-20 grayscale"
        src="https://lh3.googleusercontent.com/aida-public/AB6AXuCE_63YE24OtZYJrSOhLcjCdWnZrtRa1-pvIqMR20OyF15YXIIfnMlLuozIAyWgVnc4C58MDCxSj8UGJh7Bj15a3w2cXgvI6_t7_B3S5q-ibPZVTABb2CVrbzJGwx9XrOqgA8AT1mJcZ3_s2RKea_vRID7cB2atnQmYQeq9SPJlAvTk7u2-r8Apz42Sb2Irfu206NFEIHf_ejAkA3YadKJsZ_bZG1Rx2eniXmsU3l5CUkhOVWNs9jVtFq4awDXZ6z8MZHdhc70D7VU"
      />

      <div class="absolute bottom-6 right-4 z-40">
        <button
          onclick="updateLocation()"
          class="h-12 w-12 bg-white rounded-full flex items-center justify-center text-slate-700 shadow-lg border border-slate-100 active:scale-95 transition-transform hover:text-primary"
        >
          <span class="material-icons">my_location</span>
        </button>
      </div>
    </div>

    <!-- Content Panel -->
    <div
      class="h-[60%] w-full bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex flex-col relative z-20 -mt-8 border-t border-slate-100"
    >
      <div class="w-full flex justify-center pt-3 pb-1">
        <div class="w-10 h-1 rounded-full bg-slate-200"></div>
      </div>

      <div class="px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold text-slate-900 tracking-tight">
            Estaciones Cercanas
          </h1>
          <p id="location-name" class="text-[11px] text-slate-400 font-medium">
            Ubicación actual
          </p>
        </div>
        <div class="flex bg-slate-100 p-1 rounded-lg">
          <button
            onclick="toggleView('fuel')"
            id="btn-fuel"
            class="px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm text-primary transition-all"
          >
            ⛽️ Gas
          </button>
          <button
            onclick="toggleView('electric')"
            id="btn-electric"
            class="px-3 py-1 text-xs font-bold rounded-md text-slate-500 transition-all"
          >
            ⚡️ Luz
          </button>
        </div>
      </div>

      <div
        id="list-container"
        class="flex-1 overflow-y-auto no-scrollbar px-6 pb-24"
      >
        <!-- Items will be injected here -->
        <div
          class="flex flex-col items-center justify-center h-full opacity-30"
        >
          <span class="material-icons text-4xl mb-2">gps_fixed</span>
          <p class="text-sm font-medium">Buscando las mejores ofertas...</p>
        </div>
      </div>
    </div>

    <script>
      let currentView = 'fuel';
      let lastData = null;

      function toggleView(view) {
          currentView = view;
          document.getElementById('btn-fuel').classList.toggle('bg-white', view === 'fuel');
          document.getElementById('btn-fuel').classList.toggle('shadow-sm', view === 'fuel');
          document.getElementById('btn-fuel').classList.toggle('text-primary', view === 'fuel');
          document.getElementById('btn-fuel').classList.toggle('text-slate-500', view !== 'fuel');

          document.getElementById('btn-electric').classList.toggle('bg-white', view === 'electric');
          document.getElementById('btn-electric').classList.toggle('shadow-sm', view === 'electric');
          document.getElementById('btn-electric').classList.toggle('text-primary', view === 'electric');
          document.getElementById('btn-electric').classList.toggle('text-slate-500', view !== 'electric');

          renderData();
      }

      async function updateLocation() {
          document.getElementById('status-text').innerText = 'Localizando...';
          document.getElementById('loader').classList.remove('hidden');

          if (!navigator.geolocation) {
              alert('Geolocalización no soportada');
              return;
          }

          navigator.geolocation.getCurrentPosition(async (pos) => {
              const { latitude, longitude } = pos.coords;
              document.getElementById('status-text').innerText = 'Obteniendo datos...';

              try {
                  const res = await fetch(`/apiv1/nearby?lat=${latitude}&lon=${longitude}`);
                  const json = await res.json();

                  if (json.success) {
                      lastData = json.results;
                      renderData();
                      document.getElementById('status-text').innerText = 'Actualizado';
                      setTimeout(() => {
                          document.getElementById('status-text').innerText = 'MyFuel Online';
                          document.getElementById('loader').classList.add('hidden');
                      }, 2000);
                  }
              } catch (e) {
                  console.error(e);
                  document.getElementById('status-text').innerText = 'Error de red';
              }
          }, (err) => {
              alert('Error al obtener ubicación: ' + err.message);
              document.getElementById('status-text').innerText = 'Sin ubicación';
          });
      }

      function renderData() {
          if (!lastData) return;
          const container = document.getElementById('list-container');
          container.innerHTML = '';

          const list = currentView === 'fuel' ? lastData.fuelStations : lastData.chargers;

          if (list.length === 0) {
              container.innerHTML = '<p class="text-center py-10 text-slate-400">No hay estaciones cerca.</p>';
              return;
          }

          list.forEach((item, index) => {
              const isFuel = currentView === 'fuel';
              const dist = item.distance < 1 ? (Math.round(item.distance * 1000) + 'm') : (item.distance.toFixed(1) + 'km');
              const title = isFuel ? item['Rótulo'] : (item.name || 'Cargador');
              const address = isFuel ? item['Dirección'] : item.address;
              const priceOrPower = isFuel ?
                  (item['Precio Gasolina 95 E5'] || item['Precio Gasoleo A'] || '--') :
                  (item.connectors && item.connectors[0] ? item.connectors[0].power + 'kW' : '--');

              const html = `
                  <div class="py-5 flex items-center justify-between border-b border-slate-50 animate-[fadeIn_0.3s_ease-out]">
                      <div class="flex items-center gap-4">
                          <div class="h-12 w-12 rounded-2xl bg-slate-50 border border-slate-100 flex items-center justify-center shrink-0">
                              <span class="material-icons text-xl ${isFuel ? 'text-orange-500' : 'text-green-500'}">
                                  ${isFuel ? 'local_gas_station' : 'ev_station'}
                              </span>
                          </div>
                          <div class="flex flex-col">
                              <h3 class="text-slate-900 font-bold text-sm leading-tight">${title}</h3>
                              <div class="flex items-center text-[11px] text-slate-400 font-medium mt-1">
                                  <span class="text-primary mr-1">${dist}</span>
                                  <span class="mx-1">•</span>
                                  <span class="truncate max-w-[140px]">${address}</span>
                              </div>
                          </div>
                      </div>
                      <div class="text-right">
                          <div class="text-lg font-black text-primary tracking-tighter">
                              ${priceOrPower}${isFuel ? '<span class="text-[10px] font-bold text-slate-300 ml-0.5">€</span>' : ''}
                          </div>
                          ${index === 0 ? '<span class="text-[9px] font-black text-accent-red bg-red-50 px-1.5 py-0.5 rounded-md">TOP</span>' : ''}
                      </div>
                  </div>
              `;
              container.innerHTML += html;
          });
      }


      window.onload = updateLocation;
    </script>
  </body>
</html>
